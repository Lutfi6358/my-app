<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celestial Navigator: House of Wisdom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Quicksand:wght@300;500&family=Amiri:ital@0;1&display=swap');
        
        :root {
            --gold: #c5a059;
            --gold-bright: #e0d5b0;
            --deep-blue: #020617;
            --ethereal: rgba(197, 160, 89, 0.1);
        }

        body { margin: 0; overflow: hidden; background: var(--deep-blue); font-family: 'Quicksand', sans-serif; color: var(--gold-bright); }
        canvas { display: block; }
        h1, h2, .font-ancient { font-family: 'Cinzel', serif; }
        .arabic-style { font-family: 'Amiri', serif; }

        #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .interactive { pointer-events: auto; }
        
        .ui-card {
            background: linear-gradient(165deg, rgba(15, 23, 42, 0.9) 0%, rgba(2, 6, 23, 0.95) 100%);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(197, 160, 89, 0.4);
            padding: 40px;
            border-radius: 4px;
            text-align: center;
            box-shadow: 0 0 80px rgba(0,0,0,0.9), inset 0 0 30px rgba(197, 160, 89, 0.05);
            position: relative;
        }

        .btn-gold {
            background: var(--gold); color: #0f172a;
            padding: 14px 32px; border-radius: 2px; font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; border: 2px solid var(--gold);
            text-transform: uppercase; letter-spacing: 2px;
            font-family: 'Cinzel', serif;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .btn-gold:hover { 
            background: transparent; color: var(--gold); 
            box-shadow: 0 0 25px var(--gold); transform: translateY(-2px);
        }

        #crosshair {
            position: absolute; top: 50%; left: 50%; width: 60px; height: 60px;
            transform: translate(-50%, -50%); pointer-events: none;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #crosshair.target-locked { transform: translate(-50%, -50%) scale(1.3); }
        #crosshair.target-locked svg { stroke: #fff; filter: drop-shadow(0 0 8px #fff); }

        #compass-container {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 400px; height: 50px; pointer-events: none;
            border-top: 1px solid rgba(197, 160, 89, 0.3);
            border-bottom: 1px solid rgba(197, 160, 89, 0.3);
            mask-image: linear-gradient(to right, transparent, black, black, transparent);
        }
        #compass-strip {
            position: absolute; white-space: nowrap; height: 100%; display: flex; align-items: center;
            font-family: 'Cinzel', serif; font-size: 16px; letter-spacing: 8px; color: var(--gold);
            transition: transform 0.1s linear;
        }

        .loader {
            width: 30px; height: 30px; border: 3px solid rgba(197, 160, 89, 0.2);
            border-top-color: var(--gold); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .scanline {
            width: 100%; height: 2px; background: rgba(197, 160, 89, 0.1);
            position: absolute; top: 0; animation: scan 4s linear infinite;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .fact-card {
            border-left: 2px solid var(--gold); background: rgba(197, 160, 89, 0.05);
            padding: 1rem; margin-top: 1.5rem; animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Game Over / Win State */
        #win-screen {
            display: none;
            position: absolute; inset: 0; background: rgba(2, 6, 23, 0.9);
            z-index: 100; align-items: center; justify-content: center;
            pointer-events: auto;
        }
    </style>
</head>
<body>

<div id="ui-overlay">
    <!-- HUD -->
    <div id="crosshair">
        <svg viewBox="0 0 100 100" fill="none" stroke="#c5a059" stroke-width="1.5">
            <circle cx="50" cy="50" r="45" stroke-dasharray="4 8" />
            <path d="M50 5 L50 20 M50 80 L50 95 M5 50 L20 50 M80 50 L95 50" />
            <rect x="48" y="48" width="4" height="4" fill="#c5a059" />
        </svg>
    </div>

    <!-- Instructions -->
    <div class="absolute top-10 left-10 border-l-2 border-gold/50 pl-4 py-2 bg-black/20 backdrop-blur-sm">
        <div class="font-ancient text-[0.65rem] tracking-[0.3em] text-gold/60 mb-1">Navigation System</div>
        <div class="text-xs text-white/80 font-medium uppercase">WASD &bull; Move</div>
        <div class="text-xs text-gold font-bold uppercase">Click &bull; Target Orb</div>
    </div>

    <!-- Intro -->
    <div id="screen-intro" class="absolute inset-0 flex items-center justify-center interactive bg-[#020617]">
        <div class="ui-card max-w-2xl">
            <div class="scanline"></div>
            <div class="arabic-style text-4xl mb-4 text-gold opacity-60 tracking-widest">بيت الحكمة</div>
            <h1 class="text-6xl mb-4 text-[#c5a059] tracking-tighter">THE HOUSE OF WISDOM</h1>
            <p class="mb-10 text-slate-400 font-light tracking-wide text-lg">Journey through the celestial observatory. <br>Capture moving knowledge orbs to restore the library.</p>
            <button id="start-btn" class="btn-gold">Begin Observation</button>
        </div>
    </div>

    <!-- Compass -->
    <div id="compass-container">
        <div id="compass-strip">
            N &bull;&bull;&bull; NE &bull;&bull;&bull; E &bull;&bull;&bull; SE &bull;&bull;&bull; S &bull;&bull;&bull; SW &bull;&bull;&bull; W &bull;&bull;&bull; NW &bull;&bull;&bull; N
        </div>
        <div class="absolute top-0 left-1/2 -translate-x-1/2 w-[1px] h-full bg-white/40"></div>
    </div>

    <!-- Question Modal -->
    <div id="modal-question" class="hidden absolute inset-0 flex items-center justify-center interactive bg-black/80 backdrop-blur-md">
        <div class="ui-card max-w-xl w-full">
            <div class="font-ancient text-xs tracking-[0.5em] text-gold/60 mb-6 uppercase">Orb Data Decryption</div>
            <p id="q-text" class="text-2xl text-white mb-8 leading-snug"></p>
            <div id="q-options" class="grid grid-cols-1 gap-3"></div>
            <div id="q-feedback" class="hidden"></div>
            <div id="tts-indicator" class="mt-6 flex items-center justify-center gap-3 text-xs text-gold/80 hidden">
                <div class="loader"></div>
                <span class="font-ancient tracking-widest">TRANSCRIBING ORAL TRADITION...</span>
            </div>
        </div>
    </div>

    <!-- HUD Stats -->
    <div class="absolute top-10 right-10 text-right">
        <div class="font-ancient text-[0.65rem] tracking-[0.4em] text-gold/60 mb-2">Knowledge Restored</div>
        <div class="flex items-center gap-4 justify-end">
            <div id="score-dots" class="flex gap-1.5"></div>
            <div class="text-4xl font-ancient text-gold" id="score-display">0<span class="text-lg opacity-40">/8</span></div>
        </div>
    </div>

    <!-- Win Screen -->
    <div id="win-screen" class="interactive">
        <div class="ui-card max-w-2xl">
            <h1 class="text-6xl mb-4 text-gold font-ancient">WISDOM RESTORED</h1>
            <p class="mb-10 text-slate-400">The library of the House of Wisdom is complete once more.</p>
            <button onclick="location.reload()" class="btn-gold">Observe Again</button>
        </div>
    </div>

    <!-- AI Consult -->
    <div class="absolute bottom-10 right-10 interactive">
        <button onclick="askGemini()" class="group flex items-center gap-4 bg-black/40 hover:bg-gold/10 p-2 pr-8 rounded-full border border-gold/30 transition-all duration-500">
            <div class="w-14 h-14 rounded-full bg-gold flex items-center justify-center text-slate-900 shadow-[0_0_20px_rgba(197,160,89,0.4)] group-hover:rotate-45 transition-transform">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v18M3 12h18M5.45 5.45l13.1 13.1M18.55 5.45L5.45 18.55"/></svg>
            </div>
            <span class="font-ancient text-xs uppercase tracking-[0.2em] text-gold font-bold">Consult Archives</span>
        </button>
    </div>

    <div id="modal-ai" class="hidden absolute inset-0 flex items-center justify-center interactive bg-[#020617]/95">
        <div class="ui-card max-w-3xl w-full text-left">
            <h2 class="text-4xl mb-6 text-gold font-ancient border-b border-gold/20 pb-4">Scholarly Archives</h2>
            <div id="ai-response-content" class="text-lg leading-relaxed text-slate-300 font-serif italic h-64 overflow-y-auto pr-4">
                <div class="flex justify-center items-center h-full"><div class="loader"></div></div>
            </div>
            <button onclick="closeAI()" class="btn-gold mt-10 w-full">Return to Observatory</button>
        </div>
    </div>
</div>

<script>
    const apiKey = "";
    let scene, camera, renderer, clock;
    let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
    let velocity = new THREE.Vector3(), direction = new THREE.Vector3();
    let yaw = 0, pitch = 0, orbs = [], score = 0, activeQuestion = null;
    let raycaster = new THREE.Raycaster(), laserLine = null;

    const questions = [
        { text: "Who is known as the 'Father of Algebra' and worked at the House of Wisdom?", options: ["Al-Battani", "Al-Khwarizmi", "Ibn Sina", "Al-Razi"], correct: 1, fact: "Al-Khwarizmi's book 'Al-Jabr' gave algebra its name." },
        { text: "Which instrument was used to calculate the height of stars above the horizon?", options: ["Astrolabe", "Sundial", "Hourglass", "Compass"], correct: 0, fact: "The astrolabe was a 'mathematical jewel' used for navigation and prayer times." },
        { text: "The 'Zij' tables were essential for what scientific purpose?", options: ["Medicine", "Astronomical calculations", "Alchemy", "Poetry"], correct: 1, fact: "Zij tables recorded planetary positions, eclipses, and calendar data." },
        { text: "Which 13th-century observatory was once the most advanced in the world?", options: ["Baghdad", "Cairo", "Maragha", "Cordoba"], correct: 2, fact: "Maragha observatory housed over 400,000 manuscripts and advanced tools." },
        { text: "The 'Tusi Couple' provided a geometric solution for what?", options: ["Measuring Wind", "Planetary Motion", "Refining Salt", "Ocean Tides"], correct: 1, fact: "It allowed for linear motion to be produced from two circular motions." },
        { text: "Who correctly explained that we see objects because light reflects off them into our eyes?", options: ["Aristotle", "Ibn al-Haytham", "Ptolemy", "Galileo"], correct: 1, fact: "His 'Book of Optics' laid the foundations for the modern scientific method." },
        { text: "What did Al-Farghani calculate with incredible precision in the 9th century?", options: ["Earth's Diameter", "Speed of Sound", "Weight of Air", "Size of the Moon"], correct: 0, fact: "His measurements of Earth's size were later used by Columbus." },
        { text: "The lunar calendar used in the Islamic world is based on which cycle?", options: ["Solar Year", "Phases of the Moon", "Venus Transit", "Seasonal Winds"], correct: 1, fact: "It is approximately 11 days shorter than the solar year." }
    ];

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020617);
        scene.fog = new THREE.FogExp2(0x020617, 0.02);

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.y = 1.8;

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        clock = new THREE.Clock();
        
        // World setup
        const worldSize = 300;
        
        // Lighting
        scene.add(new THREE.AmbientLight(0x4040ff, 0.4));
        const sun = new THREE.DirectionalLight(0xffe0b0, 0.8);
        sun.position.set(50, 100, 50);
        scene.add(sun);

        // Floor with reflective-like pattern
        const floorGeo = new THREE.PlaneGeometry(worldSize, worldSize);
        const floorMat = new THREE.MeshStandardMaterial({ 
            color: 0x05080f, 
            roughness: 0.8, 
            metalness: 0.1 
        });
        const floor = new THREE.Mesh(floorGeo, floorMat);
        floor.rotation.x = -Math.PI / 2;
        scene.add(floor);

        // Decorative Grid
        const grid = new THREE.GridHelper(worldSize, 120, 0xc5a059, 0x111827);
        grid.position.y = 0.05;
        scene.add(grid);

        // Boundary Ring
        const ringGeo = new THREE.TorusGeometry(worldSize/2, 1, 16, 100);
        const ringMat = new THREE.MeshBasicMaterial({ color: 0xc5a059, transparent: true, opacity: 0.2 });
        const ring = new THREE.Mesh(ringGeo, ringMat);
        ring.rotation.x = Math.PI / 2;
        scene.add(ring);

        // Stars
        const starGeo = new THREE.BufferGeometry();
        const starPos = [];
        for(let i=0; i<5000; i++) {
            starPos.push((Math.random()-0.5)*1000, Math.random()*500, (Math.random()-0.5)*1000);
        }
        starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starPos, 3));
        scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.8 })));

        // Create Orbs
        questions.forEach((q, i) => {
            const group = new THREE.Group();
            
            const outer = new THREE.Mesh(
                new THREE.IcosahedronGeometry(1.2, 1),
                new THREE.MeshStandardMaterial({ color: 0xc5a059, wireframe: true, emissive: 0xc5a059, emissiveIntensity: 0.5 })
            );
            
            const inner = new THREE.Mesh(
                new THREE.SphereGeometry(0.5, 16, 16),
                new THREE.MeshBasicMaterial({ color: 0xffffff })
            );

            group.add(outer);
            group.add(inner);

            const angle = (i / questions.length) * Math.PI * 2;
            const radius = 50 + Math.random() * 30;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;
            
            group.position.set(x, 4 + Math.random() * 3, z);
            group.userData = {
                id: i,
                active: true,
                baseY: group.position.y,
                baseX: x,
                baseZ: z,
                phase: Math.random() * Math.PI * 2,
                speed: 0.8 + Math.random() * 1.2,
                pattern: i % 3
            };
            
            scene.add(group);
            orbs.push(group);
        });

        // Score display init
        const dots = document.getElementById('score-dots');
        for(let i=0; i<8; i++) {
            const d = document.createElement('div');
            d.id = `dot-${i}`;
            d.className = 'w-1.5 h-1.5 rounded-full border border-gold/40 transition-all duration-500';
            dots.appendChild(d);
        }

        // Input listeners
        window.addEventListener('keydown', e => { if(!activeQuestion) handleKey(e.code, true); });
        window.addEventListener('keyup', e => handleKey(e.code, false));
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('mousedown', onMouseDown);
        window.addEventListener('resize', onResize);
        
        document.getElementById('start-btn').onclick = () => {
            document.getElementById('screen-intro').classList.add('hidden');
            document.body.requestPointerLock();
            animate();
        };
    }

    function handleKey(code, val) {
        switch(code) {
            case 'KeyW': moveForward = val; break;
            case 'KeyS': moveBackward = val; break;
            case 'KeyA': moveLeft = val; break;
            case 'KeyD': moveRight = val; break;
        }
    }

    function onMouseMove(e) {
        if(document.pointerLockElement !== document.body || activeQuestion) return;
        yaw -= e.movementX * 0.002;
        pitch -= e.movementY * 0.002;
        pitch = Math.max(-1.4, Math.min(1.4, pitch));
        
        camera.rotation.order = "YXZ";
        camera.rotation.y = yaw;
        camera.rotation.x = pitch;

        const deg = (yaw * (180/Math.PI)) % 360;
        document.getElementById('compass-strip').style.transform = `translateX(${-deg * 2.22}px)`;
    }

    function onMouseDown(e) {
        if(e.button === 0 && document.pointerLockElement && !activeQuestion) fireRay();
    }

    function fireRay() {
        raycaster.setFromCamera({x:0, y:0}, camera);
        const hitGroup = raycaster.intersectObjects(orbs, true);
        
        // Beam Effect
        const start = new THREE.Vector3(0.2, -0.4, -0.5).applyMatrix4(camera.matrixWorld);
        const end = hitGroup.length > 0 ? hitGroup[0].point : raycaster.ray.at(100, new THREE.Vector3());
        
        const beamGeo = new THREE.BufferGeometry().setFromPoints([start, end]);
        const beam = new THREE.Line(beamGeo, new THREE.LineBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.8 }));
        scene.add(beam);
        setTimeout(() => scene.remove(beam), 100);

        if(hitGroup.length > 0) {
            let target = hitGroup[0].object;
            while(target.parent && !target.userData.id && target.parent !== scene) target = target.parent;
            if(target.userData.active) openQuestion(target.userData.id);
        }
    }

    function openQuestion(id) {
        activeQuestion = questions[id];
        const modal = document.getElementById('modal-question');
        modal.classList.remove('hidden');
        document.getElementById('q-text').innerText = activeQuestion.text;
        
        const opts = document.getElementById('q-options');
        opts.innerHTML = '';
        activeQuestion.options.forEach((o, i) => {
            const b = document.createElement('button');
            b.className = 'btn-gold !bg-white/5 border-gold/20 text-white hover:!bg-gold hover:!text-slate-900 lowercase font-light text-left px-6 py-4 transition-all';
            b.innerText = o;
            b.onclick = () => checkAnswer(i, id);
            opts.appendChild(b);
        });
        document.exitPointerLock();
    }

    function checkAnswer(idx, orbId) {
        const feed = document.getElementById('q-feedback');
        feed.classList.remove('hidden');
        if(idx === activeQuestion.correct) {
            feed.innerHTML = `<div class="fact-card"><div class="text-gold font-bold mb-1">ALIGNMENT SUCCESSFUL</div><div class="text-white text-sm">${activeQuestion.fact}</div></div>`;
            speak(activeQuestion.fact);
            orbs[orbId].userData.active = false;
            orbs[orbId].visible = false;
            
            document.getElementById(`dot-${score}`).classList.add('!bg-gold', 'shadow-[0_0_8px_#c5a059]');
            score++;
            document.getElementById('score-display').innerHTML = `${score}<span class="text-lg opacity-40">/8</span>`;
            
            if(score === 8) {
                setTimeout(() => {
                    document.getElementById('win-screen').style.display = 'flex';
                    document.exitPointerLock();
                }, 3000);
            }

            setTimeout(() => {
                activeQuestion = null;
                document.getElementById('modal-question').classList.add('hidden');
                feed.classList.add('hidden');
                document.body.requestPointerLock();
            }, 5000);
        } else {
            feed.innerHTML = `<div class="mt-4 text-red-400 font-ancient tracking-widest text-xs uppercase">Decryption Error - Focus Divergent</div>`;
        }
    }

    async function speak(text) {
        const ind = document.getElementById('tts-indicator');
        ind.classList.remove('hidden');
        try {
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `Scholar: ${text}` }] }],
                    generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } },
                    model: "gemini-2.5-flash-preview-tts"
                })
            });
            const res = await resp.json();
            const wav = pcmToWav(res.candidates[0].content.parts[0].inlineData.data, 24000);
            new Audio(URL.createObjectURL(wav)).play();
        } catch(e) {} finally { ind.classList.add('hidden'); }
    }

    function pcmToWav(b64, rate) {
        const buf = Uint8Array.from(atob(b64), c => c.charCodeAt(0)).buffer;
        const head = new ArrayBuffer(44);
        const v = new DataView(head);
        v.setUint32(0, 0x46464952, true); v.setUint32(4, 36 + buf.byteLength, true); v.setUint32(8, 0x45564157, true); v.setUint32(12, 0x20746d66, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true); v.setUint32(24, rate, true); v.setUint32(28, rate * 2, true); v.setUint16(32, 2, true); v.setUint16(34, 16, true); v.setUint32(36, 0x61746164, true); v.setUint32(40, buf.byteLength, true);
        return new Blob([head, buf], { type: 'audio/wav' });
    }

    async function askGemini() {
        const mod = document.getElementById('modal-ai');
        const cont = document.getElementById('ai-response-content');
        mod.classList.remove('hidden');
        cont.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader"></div></div>';
        document.exitPointerLock();
        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: "Explain the legacy of the House of Wisdom and how it preserved Greek and Indian scientific knowledge while adding original Islamic discoveries." }] }] })
            });
            const d = await r.json();
            cont.innerText = d.candidates?.[0]?.content?.parts?.[0]?.text;
        } catch(e) { cont.innerText = "The archives are temporarily inaccessible. Reconnect to the House of Wisdom."; }
    }

    function closeAI() { document.getElementById('modal-ai').classList.add('hidden'); document.body.requestPointerLock(); }
    function onResize() { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }

    function animate() {
        requestAnimationFrame(animate);
        const dt = clock.getDelta();
        const time = Date.now() * 0.001;

        if(!activeQuestion) {
            velocity.x -= velocity.x * 10 * dt;
            velocity.z -= velocity.z * 10 * dt;
            
            direction.z = Number(moveForward) - Number(moveBackward);
            direction.x = Number(moveRight) - Number(moveLeft);
            direction.normalize();

            if(moveForward || moveBackward) velocity.z -= direction.z * 60 * dt;
            if(moveLeft || moveRight) velocity.x -= direction.x * 60 * dt;

            camera.translateX(-velocity.x * dt);
            camera.translateZ(velocity.z * dt);
            
            // Boundary Clamping
            const dist = Math.sqrt(camera.position.x**2 + camera.position.z**2);
            if(dist > 145) {
                const angle = Math.atan2(camera.position.z, camera.position.x);
                camera.position.x = Math.cos(angle) * 145;
                camera.position.z = Math.sin(angle) * 145;
            }

            // Head Bob
            const bob = (moveForward || moveBackward || moveLeft || moveRight) ? Math.sin(time * 10) * 0.05 : 0;
            camera.position.y = 1.8 + bob;

            // Orb Logic
            raycaster.setFromCamera({x:0, y:0}, camera);
            const hits = raycaster.intersectObjects(orbs, true);
            document.getElementById('crosshair').className = hits.length > 0 ? 'target-locked' : '';

            orbs.forEach(o => {
                if(o.userData.active) {
                    const ud = o.userData;
                    o.rotation.y += dt;
                    o.rotation.x += dt * 0.5;

                    // Orb Pulse
                    const scale = 1 + Math.sin(time * 3 + ud.phase) * 0.1;
                    o.scale.set(scale, scale, scale);

                    // Movement Patterns
                    switch(ud.pattern) {
                        case 0: // Circle
                            o.position.x = ud.baseX + Math.cos(time * ud.speed + ud.phase) * 10;
                            o.position.z = ud.baseZ + Math.sin(time * ud.speed + ud.phase) * 10;
                            break;
                        case 1: // Vertical
                            o.position.y = ud.baseY + Math.sin(time * ud.speed * 2) * 5;
                            break;
                        case 2: // ZigZag
                            o.position.x = ud.baseX + Math.sin(time * ud.speed) * 15;
                            o.position.y = ud.baseY + Math.cos(time * ud.speed * 1.5) * 4;
                            break;
                    }
                }
            });
        }
        renderer.render(scene, camera);
    }

    window.onload = init;
</script>
</body>
</html>
