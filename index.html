import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  Card,
  CardHeader,
  CardTitle,
  CardDescription,
  CardContent,
} from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Progress } from "@/components/ui/progress";
import { Tabs, TabsList, TabsTrigger, TabsContent } from "@/components/ui/tabs";
import { Slider } from "@/components/ui/slider";
import { Switch } from "@/components/ui/switch";
import { Input } from "@/components/ui/input";
import { Separator } from "@/components/ui/separator";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { Sun, MoonStar, Compass, Sparkles, Telescope, TimerReset, CheckCircle2, XCircle, Info, BookOpen, Zap, RotateCcw, Target } from "lucide-react";

/**
 * Islamic Astronomy Mini-Game (browser-friendly, educational)
 * Single-file React component.
 *
 * Modes:
 * 1) Hilal Hunt: set sunset + moon parameters; decide if likely visible (simplified, educational model)
 * 2) Qibla Quest: estimate Qibla direction using map-like bearings (no real geodesy; game bearings)
 * 3) Prayer Time Planner: learn high-latitude rules by choosing method for scenario
 * 4) Quick Quiz: short MCQ bank
 */

// ---------- Utility ----------
const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
const round1 = (n) => Math.round(n * 10) / 10;
const round2 = (n) => Math.round(n * 100) / 100;

function seededRng(seed) {
  // simple LCG for repeatable daily seeds
  let s = seed >>> 0;
  return () => {
    s = (1664525 * s + 1013904223) >>> 0;
    return s / 4294967296;
  };
}

function todaySeed() {
  const d = new Date();
  const y = d.getFullYear();
  const m = d.getMonth() + 1;
  const day = d.getDate();
  return (y * 10000 + m * 100 + day) >>> 0;
}

// Simplified educational visibility score (NOT a fiqh ruling, NOT a scientific criterion).
// Roughly rewards altitude, elongation, age, and penalizes haze/cloud + low width.
function hilalScore({ altDeg, elongDeg, ageHours, widthArcMin, haze, clouds }) {
  const alt = clamp(altDeg, -1, 15);
  const el = clamp(elongDeg, 0, 20);
  const age = clamp(ageHours, 0, 30);
  const w = clamp(widthArcMin, 0, 1);

  const base =
    0.35 * (alt / 10) +
    0.35 * (el / 15) +
    0.2 * (age / 24) +
    0.1 * (w / 0.4);

  const weatherPenalty = (haze ? 0.14 : 0) + (clouds ? 0.22 : 0);
  const score = clamp(base - weatherPenalty, 0, 1);

  // categorize
  const likely = score >= 0.62;
  const maybe = score >= 0.45 && score < 0.62;
  return { score, likely, maybe };
}

function verdictText({ likely, maybe }) {
  if (likely) return { label: "Likely visible", tone: "good" };
  if (maybe) return { label: "Uncertain", tone: "warn" };
  return { label: "Unlikely", tone: "bad" };
}

function toneBadge(tone) {
  if (tone === "good") return "bg-emerald-500/15 text-emerald-200 border-emerald-500/30";
  if (tone === "warn") return "bg-amber-500/15 text-amber-200 border-amber-500/30";
  return "bg-rose-500/15 text-rose-200 border-rose-500/30";
}

function degDiff(a, b) {
  // shortest angular difference (0..180)
  const d = Math.abs(((a - b + 180) % 360) - 180);
  return d;
}

// ---------- Question Banks ----------
const QUIZ_BANK = [
  {
    q: "In Islamic astronomy (falak), what does ‘hilal’ usually refer to?",
    options: [
      "A meteor shower",
      "The first visible crescent after conjunction",
      "A solar eclipse",
      "The full moon",
    ],
    answer: 1,
    why: "Hilal commonly means the first visible crescent Moon marking the start of a lunar month.",
    tag: "Hilal",
  },
  {
    q: "Why can prayer times be challenging in high latitudes during summer?",
    options: [
      "Because the Moon is always below the horizon",
      "Because twilight can persist and the Sun may not reach standard angles",
      "Because the Kaaba changes location",
      "Because Earth stops rotating",
    ],
    answer: 1,
    why: "At high latitudes, twilight may not end (or becomes very short), making standard definitions difficult.",
    tag: "Prayer Times",
  },
  {
    q: "Qibla is the direction Muslims face during prayer toward:",
    options: ["Al-Aqsa Mosque", "The Kaaba in Makkah", "The North Star", "The Sun"],
    answer: 1,
    why: "Qibla direction is toward the Kaaba in Makkah.",
    tag: "Qibla",
  },
  {
    q: "Which tool is most directly used for observing the crescent in traditional rukyah?",
    options: ["Thermometer", "Telescope/Binoculars", "Seismograph", "Barometer"],
    answer: 1,
    why: "Optical aids like binoculars or telescopes can help observe the crescent (subject to local practice).",
    tag: "Observation",
  },
  {
    q: "In general, more haze and clouds at the western horizon will:",
    options: ["Increase hilal visibility", "Have no effect", "Reduce visibility", "Move the Moon"],
    answer: 2,
    why: "Atmospheric conditions strongly impact optical visibility.",
    tag: "Atmosphere",
  },
];

// ---------- Scenarios ----------
const PRAYER_SCENARIOS = [
  {
    id: "malaysia",
    title: "Equatorial-ish (e.g., Malaysia)",
    desc: "Normal night; clear separation of twilight and night.",
    lat: 5,
    summer: false,
    hint: "Standard angle-based methods usually work fine.",
    correct: ["Standard (angles)", "Local authority timetable"],
  },
  {
    id: "uk_summer",
    title: "High latitude summer (e.g., UK)",
    desc: "Very late/short night; twilight may persist.",
    lat: 52,
    summer: true,
    hint: "You may need an adjusted method (e.g., nearest latitude/day, 1/7 night, middle of night) based on authority.",
    correct: ["Middle of the night", "1/7 night", "Nearest latitude", "Nearest day"],
  },
  {
    id: "arctic",
    title: "Polar region (midnight sun)",
    desc: "Sun does not set for weeks.",
    lat: 69,
    summer: true,
    hint: "Fixed schedules and authority guidance become essential.",
    correct: ["Local authority timetable", "Nearest latitude"],
  },
];

const PRAYER_METHODS = [
  {
    name: "Standard (angles)",
    detail: "Uses sun angles for Fajr/Isha (works where twilight behaves normally).",
  },
  {
    name: "Middle of the night",
    detail: "Splits night into halves; Fajr/Isha set around midpoint (used in some high-latitude guidance).",
  },
  {
    name: "1/7 night",
    detail: "Divides night into 7 parts; allocates twilight portion (seen in some fiqh discussions).",
  },
  {
    name: "Nearest latitude",
    detail: "Adopts times from a latitude where twilight is normal (e.g., 48°).",
  },
  {
    name: "Nearest day",
    detail: "Uses nearest day when angles become valid again.",
  },
  {
    name: "Local authority timetable",
    detail: "Follow official timetable/masjid guidance for your region.",
  },
];

// Qibla mini-bearings game: cities with pre-made Qibla bearings (approx) for gameplay.
// Note: These bearings are coarse and for game learning only.
const QIBLA_LEVELS = [
  { city: "Kuala Lumpur", bearing: 292, tip: "From SE Asia, Qibla is roughly WNW." },
  { city: "London", bearing: 118, tip: "From UK, Qibla is roughly ESE." },
  { city: "Tokyo", bearing: 263, tip: "From Japan, Qibla is roughly W." },
  { city: "Cape Town", bearing: 25, tip: "From South Africa, Qibla is roughly NNE." },
  { city: "New York", bearing: 58, tip: "From USA East Coast, Qibla is roughly NE." },
];

// ---------- Main Component ----------
export default function IslamicAstronomyMiniGame() {
  const [tab, setTab] = useState("hilal");

  // Global progression
  const [xp, setXp] = useState(0);
  const level = Math.floor(xp / 120) + 1;
  const xpInLevel = xp % 120;

  // Daily challenge seed
  const rng = useMemo(() => seededRng(todaySeed()), []);

  // ---------- Hilal Hunt ----------
  const [altDeg, setAltDeg] = useState(2.2);
  const [elongDeg, setElongDeg] = useState(7.0);
  const [ageHours, setAgeHours] = useState(16);
  const [widthArcMin, setWidthArcMin] = useState(0.12);
  const [haze, setHaze] = useState(false);
  const [clouds, setClouds] = useState(false);
  const [hilalLog, setHilalLog] = useState([]);

  const hs = useMemo(
    () => hilalScore({ altDeg, elongDeg, ageHours, widthArcMin, haze, clouds }),
    [altDeg, elongDeg, ageHours, widthArcMin, haze, clouds]
  );
  const verdict = useMemo(() => verdictText(hs), [hs]);

  function randomHilal() {
    // generate a plausible teaching case
    const alt = round1(0.5 + rng() * 6.0);
    const el = round1(4.0 + rng() * 8.0);
    const age = Math.round(8 + rng() * 18);
    const w = round2(0.04 + rng() * 0.26);
    const hz = rng() < 0.35;
    const cl = rng() < 0.25;
    setAltDeg(alt);
    setElongDeg(el);
    setAgeHours(age);
    setWidthArcMin(w);
    setHaze(hz);
    setClouds(cl);
  }

  function submitHilalDecision(decision) {
    // decision: 'seen' or 'not'
    const correct = hs.likely ? decision === "seen" : hs.maybe ? false : decision === "not";
    // In uncertain zone, force learning: treat as partial (no big penalty)
    let delta = 0;
    if (hs.maybe) delta = decision === "seen" ? 8 : 8; // both acceptable, it's uncertain
    else delta = correct ? 20 : 5;

    setXp((x) => x + delta);
    setHilalLog((prev) => [
      {
        id: crypto.randomUUID(),
        altDeg,
        elongDeg,
        ageHours,
        widthArcMin,
        haze,
        clouds,
        decision,
        verdict: verdict.label,
        score: hs.score,
        delta,
      },
      ...prev,
    ].slice(0, 8));
  }

  // ---------- Qibla Quest ----------
  const [qLevelIdx, setQLevelIdx] = useState(() => Math.floor(rng() * QIBLA_LEVELS.length));
  const qLevel = QIBLA_LEVELS[qLevelIdx];
  const [guessBearing, setGuessBearing] = useState(0);
  const [qiblaHistory, setQiblaHistory] = useState([]);

  function nextQiblaLevel() {
    setQLevelIdx((i) => (i + 1) % QIBLA_LEVELS.length);
    setGuessBearing(0);
  }

  function submitQibla() {
    const diff = degDiff(guessBearing, qLevel.bearing);
    const stars = diff <= 6 ? 3 : diff <= 15 ? 2 : diff <= 30 ? 1 : 0;
    const delta = 6 + stars * 10;
    setXp((x) => x + delta);
    setQiblaHistory((prev) => [
      {
        id: crypto.randomUUID(),
        city: qLevel.city,
        target: qLevel.bearing,
        guess: guessBearing,
        diff,
        stars,
        delta,
      },
      ...prev,
    ].slice(0, 8));
    nextQiblaLevel();
  }

  // ---------- Prayer Planner ----------
  const [pScenarioId, setPScenarioId] = useState(PRAYER_SCENARIOS[0].id);
  const scenario = useMemo(
    () => PRAYER_SCENARIOS.find((s) => s.id === pScenarioId) ?? PRAYER_SCENARIOS[0],
    [pScenarioId]
  );
  const [methodPick, setMethodPick] = useState(PRAYER_METHODS[0].name);
  const [plannerLog, setPlannerLog] = useState([]);

  function submitPlanner() {
    const ok = scenario.correct.includes(methodPick);
    const delta = ok ? 20 : 7;
    setXp((x) => x + delta);
    setPlannerLog((prev) => [
      {
        id: crypto.randomUUID(),
        scenario: scenario.title,
        method: methodPick,
        ok,
        delta,
      },
      ...prev,
    ].slice(0, 8));
  }

  // ---------- Quiz ----------
  const [quizIdx, setQuizIdx] = useState(() => Math.floor(rng() * QUIZ_BANK.length));
  const [quizPick, setQuizPick] = useState(null);
  const [quizFeedback, setQuizFeedback] = useState(null);
  const [quizStreak, setQuizStreak] = useState(0);

  function nextQuiz() {
    setQuizIdx((i) => (i + 1) % QUIZ_BANK.length);
    setQuizPick(null);
    setQuizFeedback(null);
  }

  function submitQuiz() {
    if (quizPick == null) return;
    const item = QUIZ_BANK[quizIdx];
    const ok = quizPick === item.answer;
    const delta = ok ? 18 + Math.min(quizStreak, 5) * 2 : 6;
    setXp((x) => x + delta);
    setQuizStreak((s) => (ok ? s + 1 : 0));
    setQuizFeedback({ ok, why: item.why, delta });
  }

  // ---------- UI Helpers ----------
  const LevelChip = () => (
    <div className="flex items-center gap-2">
      <Badge className="rounded-full">Level {level}</Badge>
      <div className="w-44">
        <Progress value={(xpInLevel / 120) * 100} />
      </div>
      <span className="text-xs text-white/70">{xpInLevel}/120 XP</span>
    </div>
  );

  const Header = () => (
    <div className="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
      <div className="space-y-1">
        <div className="inline-flex items-center gap-2">
          <div className="h-10 w-10 rounded-2xl bg-white/10 flex items-center justify-center">
            <MoonStar className="h-5 w-5" />
          </div>
          <div>
            <h1 className="text-2xl font-semibold tracking-tight">Falak Arcade</h1>
            <p className="text-sm text-white/70">Learn Islamic astronomy concepts through mini-challenges.</p>
          </div>
        </div>
      </div>
      <LevelChip />
    </div>
  );

  // ---------- Render ----------
  return (
    <TooltipProvider>
      <div className="min-h-[calc(100vh-2rem)] w-full p-4 md:p-8">
        <div className="mx-auto max-w-6xl space-y-6">
          <Header />

          <Card className="rounded-2xl border-white/10 bg-white/5 shadow-xl">
            <CardHeader className="pb-2">
              <CardTitle className="text-lg flex items-center gap-2">
                <Sparkles className="h-4 w-4" />
                Choose a mode
              </CardTitle>
              <CardDescription>
                These activities are educational simulations (not official criteria). Use your local authority for real decisions.
              </CardDescription>
            </CardHeader>
            <CardContent>
              <Tabs value={tab} onValueChange={setTab}>
                <TabsList className="grid grid-cols-2 md:grid-cols-4 w-full">
                  <TabsTrigger value="hilal" className="gap-2"><Telescope className="h-4 w-4" />Hilal Hunt</TabsTrigger>
                  <TabsTrigger value="qibla" className="gap-2"><Compass className="h-4 w-4" />Qibla Quest</TabsTrigger>
                  <TabsTrigger value="prayer" className="gap-2"><Sun className="h-4 w-4" />Prayer Planner</TabsTrigger>
                  <TabsTrigger value="quiz" className="gap-2"><BookOpen className="h-4 w-4" />Quick Quiz</TabsTrigger>
                </TabsList>

                {/* HILAL */}
                <TabsContent value="hilal" className="mt-5">
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <Card className="rounded-2xl border-white/10 bg-white/5">
                      <CardHeader>
                        <CardTitle className="text-base flex items-center justify-between">
                          <span className="inline-flex items-center gap-2"><Telescope className="h-4 w-4" />Setup</span>
                          <Button variant="secondary" className="rounded-xl" onClick={randomHilal}>
                            <Zap className="h-4 w-4 mr-2" />Random case
                          </Button>
                        </CardTitle>
                        <CardDescription>Adjust parameters and decide: seen or not seen.</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-5">
                        <Control
                          label="Moon altitude at sunset (°)"
                          value={altDeg}
                          min={-0.5}
                          max={12}
                          step={0.1}
                          onChange={setAltDeg}
                          hint="Higher altitude generally improves chances."
                        />
                        <Control
                          label="Elongation (°)"
                          value={elongDeg}
                          min={0}
                          max={18}
                          step={0.1}
                          onChange={setElongDeg}
                          hint="Wider separation from Sun helps visibility."
                        />
                        <Control
                          label="Moon age after conjunction (hours)"
                          value={ageHours}
                          min={0}
                          max={30}
                          step={1}
                          onChange={setAgeHours}
                          hint="Older crescents tend to be easier."
                        />
                        <Control
                          label="Crescent width (arcmin)"
                          value={widthArcMin}
                          min={0}
                          max={0.6}
                          step={0.01}
                          onChange={setWidthArcMin}
                          hint="Thicker crescents are usually brighter."
                        />
                        <div className="flex items-center justify-between rounded-2xl bg-white/5 border border-white/10 p-3">
                          <div className="space-y-0.5">
                            <div className="text-sm font-medium">Haze</div>
                            <div className="text-xs text-white/70">Light scattering reduces contrast.</div>
                          </div>
                          <Switch checked={haze} onCheckedChange={setHaze} />
                        </div>
                        <div className="flex items-center justify-between rounded-2xl bg-white/5 border border-white/10 p-3">
                          <div className="space-y-0.5">
                            <div className="text-sm font-medium">Clouds near horizon</div>
                            <div className="text-xs text-white/70">Blocks the crescent even if geometry is good.</div>
                          </div>
                          <Switch checked={clouds} onCheckedChange={setClouds} />
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <Button className="rounded-xl" onClick={() => submitHilalDecision("seen")}>
                            <CheckCircle2 className="h-4 w-4 mr-2" />Seen
                          </Button>
                          <Button variant="secondary" className="rounded-xl" onClick={() => submitHilalDecision("not")}>
                            <XCircle className="h-4 w-4 mr-2" />Not seen
                          </Button>
                        </div>
                      </CardContent>
                    </Card>

                    <Card className="rounded-2xl border-white/10 bg-white/5 lg:col-span-2">
                      <CardHeader>
                        <CardTitle className="text-base flex items-center justify-between">
                          <span className="inline-flex items-center gap-2"><Target className="h-4 w-4" />Analysis</span>
                          <Badge className={`rounded-full border ${toneBadge(verdict.tone)}`}>{verdict.label}</Badge>
                        </CardTitle>
                        <CardDescription>
                          Educational visibility score: {Math.round(hs.score * 100)} / 100
                        </CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                          <div className="flex items-start gap-3">
                            <Info className="h-5 w-5 mt-0.5 text-white/70" />
                            <div className="space-y-1">
                              <div className="text-sm font-medium">How to think about it</div>
                              <ul className="text-sm text-white/70 list-disc pl-5 space-y-1">
                                <li>Altitude + elongation set the geometry of a thin crescent near sunset.</li>
                                <li>Age and width relate to illumination/brightness (simplified).</li>
                                <li>Haze/clouds can dominate real outcomes even with good geometry.</li>
                              </ul>
                            </div>
                          </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <Card className="rounded-2xl border-white/10 bg-white/5">
                            <CardHeader className="pb-2">
                              <CardTitle className="text-sm">Your recent attempts</CardTitle>
                              <CardDescription>Earn more XP by learning patterns.</CardDescription>
                            </CardHeader>
                            <CardContent className="space-y-3">
                              {hilalLog.length === 0 ? (
                                <div className="text-sm text-white/60">No attempts yet. Try a case and decide.</div>
                              ) : (
                                <div className="space-y-2">
                                  {hilalLog.map((r) => (
                                    <div key={r.id} className="rounded-xl border border-white/10 bg-white/5 p-3">
                                      <div className="flex items-center justify-between">
                                        <div className="text-sm font-medium">{r.verdict}</div>
                                        <Badge className="rounded-full">+{r.delta} XP</Badge>
                                      </div>
                                      <div className="text-xs text-white/70 mt-1">
                                        Alt {r.altDeg}°, El {r.elongDeg}°, Age {r.ageHours}h, Width {r.widthArcMin}′
                                        {r.haze ? " • haze" : ""}{r.clouds ? " • clouds" : ""}
                                      </div>
                                      <div className="text-xs text-white/60 mt-1">You chose: {r.decision === "seen" ? "Seen" : "Not seen"}</div>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </CardContent>
                          </Card>

                          <Card className="rounded-2xl border-white/10 bg-white/5">
                            <CardHeader className="pb-2">
                              <CardTitle className="text-sm">Mini goals</CardTitle>
                              <CardDescription>Try these to master the concept.</CardDescription>
                            </CardHeader>
                            <CardContent className="space-y-2 text-sm text-white/70">
                              <Goal text="Create a ‘likely visible’ case without haze/clouds." />
                              <Goal text="Turn on haze and observe how the verdict changes." />
                              <Goal text="Keep geometry the same, increase width—what happens?" />
                              <Goal text="Find a case where the verdict is ‘Uncertain’." />
                            </CardContent>
                          </Card>
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                </TabsContent>

                {/* QIBLA */}
                <TabsContent value="qibla" className="mt-5">
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <Card className="rounded-2xl border-white/10 bg-white/5">
                      <CardHeader>
                        <CardTitle className="text-base flex items-center justify-between">
                          <span className="inline-flex items-center gap-2"><Compass className="h-4 w-4" />Target city</span>
                          <Button variant="secondary" className="rounded-xl" onClick={nextQiblaLevel}>
                            <RotateCcw className="h-4 w-4 mr-2" />Change
                          </Button>
                        </CardTitle>
                        <CardDescription>Estimate the Qibla bearing (0–359°).</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                          <div className="text-lg font-semibold">{qLevel.city}</div>
                          <div className="text-sm text-white/70 mt-1">Tip: {qLevel.tip}</div>
                        </div>

                        <div className="space-y-2">
                          <div className="flex items-center justify-between">
                            <div className="text-sm font-medium">Your guess</div>
                            <Badge className="rounded-full">{guessBearing}°</Badge>
                          </div>
                          <Slider
                            value={[guessBearing]}
                            min={0}
                            max={359}
                            step={1}
                            onValueChange={(v) => setGuessBearing(v[0])}
                          />
                          <div className="text-xs text-white/60">0° = North, 90° = East, 180° = South, 270° = West</div>
                        </div>

                        <Button className="rounded-xl w-full" onClick={submitQibla}>
                          <Compass className="h-4 w-4 mr-2" />Submit bearing
                        </Button>
                      </CardContent>
                    </Card>

                    <Card className="rounded-2xl border-white/10 bg-white/5 lg:col-span-2">
                      <CardHeader>
                        <CardTitle className="text-base">Results & learning</CardTitle>
                        <CardDescription>Closer guesses earn more stars and XP.</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                          <div className="flex items-start gap-3">
                            <Info className="h-5 w-5 mt-0.5 text-white/70" />
                            <div className="space-y-1">
                              <div className="text-sm font-medium">Real-world note</div>
                              <div className="text-sm text-white/70">
                                Accurate Qibla uses great-circle direction on Earth (geodesy). This game uses simplified bearings to build intuition.
                              </div>
                            </div>
                          </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <Card className="rounded-2xl border-white/10 bg-white/5">
                            <CardHeader className="pb-2">
                              <CardTitle className="text-sm">Recent attempts</CardTitle>
                            </CardHeader>
                            <CardContent className="space-y-2">
                              {qiblaHistory.length === 0 ? (
                                <div className="text-sm text-white/60">No attempts yet.</div>
                              ) : (
                                qiblaHistory.map((r) => (
                                  <div key={r.id} className="rounded-xl border border-white/10 bg-white/5 p-3">
                                    <div className="flex items-center justify-between">
                                      <div className="text-sm font-medium">{r.city}</div>
                                      <Badge className="rounded-full">+{r.delta} XP</Badge>
                                    </div>
                                    <div className="text-xs text-white/70 mt-1">
                                      Target {r.target}° • You {r.guess}° • Δ {Math.round(r.diff)}°
                                    </div>
                                    <div className="text-xs text-white/60 mt-1">
                                      Stars: {"★".repeat(r.stars)}{"☆".repeat(3 - r.stars)}
                                    </div>
                                  </div>
                                ))
                              )}
                            </CardContent>
                          </Card>

                          <Card className="rounded-2xl border-white/10 bg-white/5">
                            <CardHeader className="pb-2">
                              <CardTitle className="text-sm">Practice ideas</CardTitle>
                            </CardHeader>
                            <CardContent className="space-y-2 text-sm text-white/70">
                              <Goal text="Try to get 3 stars (≤ 6° error)." />
                              <Goal text="Notice how Qibla changes by region (UK vs Malaysia)." />
                              <Goal text="Explain why great-circle matters on a sphere." />
                              <Goal text="Relate compass bearings to map orientation." />
                            </CardContent>
                          </Card>
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                </TabsContent>

                {/* PRAYER */}
                <TabsContent value="prayer" className="mt-5">
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <Card className="rounded-2xl border-white/10 bg-white/5">
                      <CardHeader>
                        <CardTitle className="text-base flex items-center gap-2"><Sun className="h-4 w-4" />Scenario</CardTitle>
                        <CardDescription>Select a location/season and choose a method.</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        <div className="space-y-2">
                          <div className="text-sm font-medium">Choose scenario</div>
                          <div className="grid grid-cols-1 gap-2">
                            {PRAYER_SCENARIOS.map((s) => (
                              <button
                                key={s.id}
                                onClick={() => setPScenarioId(s.id)}
                                className={`text-left rounded-2xl border p-3 transition ${
                                  s.id === pScenarioId
                                    ? "border-white/20 bg-white/10"
                                    : "border-white/10 bg-white/5 hover:bg-white/10"
                                }`}
                              >
                                <div className="flex items-center justify-between">
                                  <div className="text-sm font-semibold">{s.title}</div>
                                  <Badge className="rounded-full">~{s.lat}°</Badge>
                                </div>
                                <div className="text-xs text-white/70 mt-1">{s.desc}</div>
                              </button>
                            ))}
                          </div>
                        </div>

                        <Separator className="bg-white/10" />

                        <div className="space-y-2">
                          <div className="text-sm font-medium">Choose method</div>
                          <select
                            value={methodPick}
                            onChange={(e) => setMethodPick(e.target.value)}
                            className="w-full rounded-xl bg-black/20 border border-white/10 p-2 text-sm"
                          >
                            {PRAYER_METHODS.map((m) => (
                              <option key={m.name} value={m.name}>{m.name}</option>
                            ))}
                          </select>
                          <div className="text-xs text-white/70">
                            {PRAYER_METHODS.find((m) => m.name === methodPick)?.detail}
                          </div>
                        </div>

                        <Button className="rounded-xl w-full" onClick={submitPlanner}>
                          <TimerReset className="h-4 w-4 mr-2" />Submit method
                        </Button>
                      </CardContent>
                    </Card>

                    <Card className="rounded-2xl border-white/10 bg-white/5 lg:col-span-2">
                      <CardHeader>
                        <CardTitle className="text-base">Feedback</CardTitle>
                        <CardDescription>Compare your pick with common high-latitude guidance options.</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                          <div className="flex items-start gap-3">
                            <Info className="h-5 w-5 mt-0.5 text-white/70" />
                            <div className="space-y-1">
                              <div className="text-sm font-medium">Hint</div>
                              <div className="text-sm text-white/70">{scenario.hint}</div>
                            </div>
                          </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <Card className="rounded-2xl border-white/10 bg-white/5">
                            <CardHeader className="pb-2">
                              <CardTitle className="text-sm">Commonly acceptable choices (in this game)</CardTitle>
                              <CardDescription>Different councils use different rules.</CardDescription>
                            </CardHeader>
                            <CardContent className="space-y-2">
                              <div className="flex flex-wrap gap-2">
                                {scenario.correct.map((c) => (
                                  <Badge key={c} className="rounded-full" variant="secondary">{c}</Badge>
                                ))}
                              </div>
                              <div className="text-xs text-white/60 mt-2">
                                Real practice depends on fiqh positions and local authority decisions.
                              </div>
                            </CardContent>
                          </Card>

                          <Card className="rounded-2xl border-white/10 bg-white/5">
                            <CardHeader className="pb-2">
                              <CardTitle className="text-sm">Your recent picks</CardTitle>
                            </CardHeader>
                            <CardContent className="space-y-2">
                              {plannerLog.length === 0 ? (
                                <div className="text-sm text-white/60">No submissions yet.</div>
                              ) : (
                                plannerLog.map((r) => (
                                  <div key={r.id} className="rounded-xl border border-white/10 bg-white/5 p-3">
                                    <div className="flex items-center justify-between">
                                      <div className="text-sm font-medium">{r.scenario}</div>
                                      <Badge className="rounded-full">+{r.delta} XP</Badge>
                                    </div>
                                    <div className="text-xs text-white/70 mt-1">Method: {r.method}</div>
                                    <div className={`text-xs mt-1 ${r.ok ? "text-emerald-200" : "text-amber-200"}`}>
                                      {r.ok ? "Reasonable for this scenario" : "Less suitable here (try another rule)"}
                                    </div>
                                  </div>
                                ))
                              )}
                            </CardContent>
                          </Card>
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                </TabsContent>

                {/* QUIZ */}
                <TabsContent value="quiz" className="mt-5">
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <Card className="rounded-2xl border-white/10 bg-white/5">
                      <CardHeader>
                        <CardTitle className="text-base flex items-center justify-between">
                          <span className="inline-flex items-center gap-2"><BookOpen className="h-4 w-4" />Question</span>
                          <Badge className="rounded-full" variant="secondary">{QUIZ_BANK[quizIdx].tag}</Badge>
                        </CardTitle>
                        <CardDescription>Streak: {quizStreak}</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-3">
                        <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
                          <div className="text-sm font-medium">{QUIZ_BANK[quizIdx].q}</div>
                        </div>

                        <div className="space-y-2">
                          {QUIZ_BANK[quizIdx].options.map((opt, idx) => (
                            <button
                              key={opt}
                              onClick={() => setQuizPick(idx)}
                              className={`w-full text-left rounded-2xl border p-3 transition ${
                                quizPick === idx
                                  ? "border-white/20 bg-white/10"
                                  : "border-white/10 bg-white/5 hover:bg-white/10"
                              }`}
                            >
                              <div className="text-sm">{opt}</div>
                            </button>
                          ))}
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                          <Button className="rounded-xl" onClick={submitQuiz}>Submit</Button>
                          <Button variant="secondary" className="rounded-xl" onClick={nextQuiz}>Next</Button>
                        </div>

                        <AnimatePresence>
                          {quizFeedback && (
                            <motion.div
                              initial={{ opacity: 0, y: 8 }}
                              animate={{ opacity: 1, y: 0 }}
                              exit={{ opacity: 0, y: 8 }}
                              className={`rounded-2xl border p-3 ${
                                quizFeedback.ok
                                  ? "border-emerald-500/30 bg-emerald-500/10"
                                  : "border-rose-500/30 bg-rose-500/10"
                              }`}
                            >
                              <div className="flex items-center justify-between">
                                <div className="text-sm font-medium">
                                  {quizFeedback.ok ? "Correct" : "Not quite"}
                                </div>
                                <Badge className="rounded-full">+{quizFeedback.delta} XP</Badge>
                              </div>
                              <div className="text-xs text-white/70 mt-1">{quizFeedback.why}</div>
                            </motion.div>
                          )}
                        </AnimatePresence>
                      </CardContent>
                    </Card>

                    <Card className="rounded-2xl border-white/10 bg-white/5 lg:col-span-2">
                      <CardHeader>
                        <CardTitle className="text-base">Build your own set</CardTitle>
                        <CardDescription>Add questions for your class or journal club.</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <QuizBuilder
                          onAdd={(item) => {
                            QUIZ_BANK.push(item);
                            setXp((x) => x + 10);
                          }}
                        />
                      </CardContent>
                    </Card>
                  </div>
                </TabsContent>
              </Tabs>
            </CardContent>
          </Card>

          <Footer xp={xp} level={level} />
        </div>
      </div>
    </TooltipProvider>
  );
}

function Goal({ text }) {
  return (
    <div className="flex items-start gap-2">
      <div className="mt-1 h-2 w-2 rounded-full bg-white/40" />
      <div>{text}</div>
    </div>
  );
}

function Control({ label, value, min, max, step, onChange, hint }) {
  return (
    <div className="space-y-2">
      <div className="flex items-center justify-between">
        <div className="text-sm font-medium flex items-center gap-2">
          {label}
          <Tooltip>
            <TooltipTrigger asChild>
              <button className="inline-flex items-center justify-center h-6 w-6 rounded-xl bg-white/5 border border-white/10">
                <Info className="h-3.5 w-3.5 text-white/70" />
              </button>
            </TooltipTrigger>
            <TooltipContent className="max-w-xs">
              <p className="text-xs">{hint}</p>
            </TooltipContent>
          </Tooltip>
        </div>
        <Badge className="rounded-full" variant="secondary">{value}</Badge>
      </div>
      <Slider
        value={[value]}
        min={min}
        max={max}
        step={step}
        onValueChange={(v) => onChange(v[0])}
      />
      <div className="flex items-center justify-between text-xs text-white/60">
        <span>{min}</span>
        <span>{max}</span>
      </div>
    </div>
  );
}

function QuizBuilder({ onAdd }) {
  const [q, setQ] = useState("");
  const [a, setA] = useState("");
  const [b, setB] = useState("");
  const [c, setC] = useState("");
  const [d, setD] = useState("");
  const [ans, setAns] = useState("B");
  const [tag, setTag] = useState("Custom");
  const [why, setWhy] = useState("");

  function add() {
    const opts = [a, b, c, d].map((s) => s.trim()).filter(Boolean);
    if (!q.trim() || opts.length < 2) return;
    const idx = ans === "A" ? 0 : ans === "B" ? 1 : ans === "C" ? 2 : 3;
    const item = {
      q: q.trim(),
      options: [a || "Option A", b || "Option B", c || "Option C", d || "Option D"],
      answer: idx,
      why: why.trim() || "", 
      tag: tag.trim() || "Custom",
    };
    onAdd(item);
    setQ(""); setA(""); setB(""); setC(""); setD(""); setWhy("");
  }

  return (
    <div className="space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div className="space-y-2">
          <div className="text-sm font-medium">Question</div>
          <Input value={q} onChange={(e) => setQ(e.target.value)} placeholder="Write a question about falak..." className="rounded-xl" />
        </div>
        <div className="space-y-2">
          <div className="text-sm font-medium">Tag</div>
          <Input value={tag} onChange={(e) => setTag(e.target.value)} placeholder="Hilal / Qibla / Prayer Times" className="rounded-xl" />
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        <Input value={a} onChange={(e) => setA(e.target.value)} placeholder="Option A" className="rounded-xl" />
        <Input value={b} onChange={(e) => setB(e.target.value)} placeholder="Option B" className="rounded-xl" />
        <Input value={c} onChange={(e) => setC(e.target.value)} placeholder="Option C" className="rounded-xl" />
        <Input value={d} onChange={(e) => setD(e.target.value)} placeholder="Option D" className="rounded-xl" />
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <div className="space-y-2">
          <div className="text-sm font-medium">Correct answer</div>
          <select value={ans} onChange={(e) => setAns(e.target.value)} className="w-full rounded-xl bg-black/20 border border-white/10 p-2 text-sm">
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>
        </div>
        <div className="space-y-2 md:col-span-2">
          <div className="text-sm font-medium">Explanation (optional)</div>
          <Input value={why} onChange={(e) => setWhy(e.target.value)} placeholder="Why is that the correct answer?" className="rounded-xl" />
        </div>
      </div>

      <Button className="rounded-xl" onClick={add}>Add question (+10 XP)</Button>

      <div className="rounded-2xl border border-white/10 bg-white/5 p-4">
        <div className="flex items-start gap-2">
          <Info className="h-4 w-4 mt-0.5 text-white/70" />
          <div className="text-sm text-white/70">
            Tip: you can tailor questions to your course (rukyah criteria, fiqh, image processing, light pollution, etc.).
          </div>
        </div>
      </div>
    </div>
  );
}

function Footer({ xp, level }) {
  return (
    <Card className="rounded-2xl border-white/10 bg-white/5">
      <CardContent className="p-5">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div className="space-y-1">
            <div className="text-sm font-medium">Your progress</div>
            <div className="text-xs text-white/70">Total XP: {xp} • Level {level}</div>
          </div>
          <div className="flex flex-wrap gap-2">
            <Badge className="rounded-full" variant="secondary">Hilal</Badge>
            <Badge className="rounded-full" variant="secondary">Qibla</Badge>
            <Badge className="rounded-full" variant="secondary">Prayer Times</Badge>
            <Badge className="rounded-full" variant="secondary">Quiz</Badge>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
